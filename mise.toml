[tools]
"go:github.com/gohugoio/hugo" = "v0.155.2"
"go:github.com/grafana/oats" = "0.6.0"
java = "temurin-25.0.2+10.0.LTS"
lychee = "0.22.0"
protoc = "33.5"

[env]
# renovate: datasource=docker depName=ghcr.io/super-linter/super-linter
SUPER_LINTER_VERSION="v8.4.0@sha256:c5e3307932203ff9e1e8acfe7e92e894add6266605b5d7fb525fb371a59a26f4"

[tasks.ci]
description = "CI Build"
run = "./mvnw clean install"
env.REQUIRE_PROTO_UP_TO_DATE = "true"
env.PROTO_GENERATION = "true"

[tasks.format]
description = "format source code"
run = "./mvnw spotless:apply"

[tasks.clean]
description = "clean all modules"
run = "./mvnw clean"

[tasks.compile]
description = "bare compile, ignoring formatting and linters"
run = "./mvnw install -DskipTests -Dspotless.check.skip=true -Dcoverage.skip=true -Dcheckstyle.skip=true -Dwarnings=-nowarn"

[tasks.generate]
description = "bare compile, ignoring formatting and linters"
run = [
  "mise use --pin protoc@latest",
  "./mvnw clean install -DskipTests -Dspotless.check.skip=true -Dcoverage.skip=true -Dcheckstyle.skip=true -Dwarnings=-nowarn"
]
env.PROTO_GENERATION = "true"

[tasks.test]
description = "run unit tests, ignoring formatting and linters"
run = "./mvnw test -Dspotless.check.skip=true -Dcoverage.skip=true -Dcheckstyle.skip=true -Dwarnings=-nowarn"

[tasks.test-all]
description = "run all tests"
run = "./mvnw verify"

[tasks.build]
description = "build all modules without tests"
run = "./mvnw install -DskipTests -Dcoverage.skip=true"

[tasks."lint:super-linter"]
description = "Run Super-Linter with auto-fix on the repository"
file = "https://raw.githubusercontent.com/grafana/docker-otel-lgtm/main/.mise/tasks/lint/super-linter.sh"

[tasks."lint:links"]
file = "https://raw.githubusercontent.com/open-telemetry/opentelemetry-java-contrib/refs/heads/main/.mise/tasks/lint/links.sh"

[tasks."lint:local-links"]
file = "https://raw.githubusercontent.com/open-telemetry/opentelemetry-java-contrib/refs/heads/main/.mise/tasks/lint/local-links.sh"

[tasks."lint:links-in-modified-files"]
file = "https://raw.githubusercontent.com/open-telemetry/opentelemetry-java-contrib/refs/heads/main/.mise/tasks/lint/links-in-modified-files.sh"

[tasks."lint:links-in-modified-files-ci"]
description = "Lint links in modified files (CI configuration)"
run = "mise run lint:links-in-modified-files --base origin/$GITHUB_BASE_REF --head $GITHUB_HEAD_SHA"

[tasks."lint:links-in-modified-files-local"]
description = "Lint links in modified files (local configuration)"
run = "mise run lint:links-in-modified-files --base origin/main --head HEAD"

[tasks."lint:rest"]
description = "All lints not covered by super linter"
depends = ["lint:bom", "lint:local-links", "lint:links-in-modified-files-local"]

[tasks."lint:rest-ci"]
description = "All lints not covered by super linter (CI configuration)"
depends = ["lint:bom", "lint:local-links", "lint:links-in-modified-files-ci"]

[tasks."lint:all"]
description = "All lints"
depends = ["lint:rest", "lint:super-linter"]

[tasks.acceptance-test]
description = "Run OATs acceptance tests"
depends = "build"
run = "oats -timeout 5m examples/"

[tasks.javadoc]
description = "Generate Javadoc"
run = [
  "./mvnw -B clean compile javadoc:javadoc javadoc:aggregate -P 'javadoc,!default'",
  "rm -rf ./docs/static/api",
  "mv ./target/reports/apidocs ./docs/static/api && echo && echo 'ls ./docs/static/api' && ls ./docs/static/api"
]

[tasks.gh-pages-dev]
description = "Build GitHub pages for dev"
run = "hugo server -D"
dir = "docs"

[tasks.build-gh-pages]
description = "Build GitHub pages"
depends = ["javadoc", "set-release-version-github-pages"]
# For maximum backward compatibility with Hugo modules
env = { HUGO_ENVIRONMENT = "production", HUGO_ENV = "production" }
dir = "docs"
run = [
  "hugo --gc --minify --baseURL ${BASE_URL}/",
  "echo 'ls ./public/api' && ls ./public/api"
]

[tasks."benchmark:quick"]
description = "Run benchmarks with reduced iterations (quick smoke test, ~10 min)"
run = "python3 ./.mise/tasks/update_benchmarks.py --jmh-args '-f 1 -wi 1 -i 3'"

[tasks."benchmark:ci"]
description = "Run benchmarks with CI configuration (3 forks, 3 warmup, 5 measurement iterations (~60 min total)"
run = "python3 ./.mise/tasks/update_benchmarks.py --jmh-args '-f 3 -wi 3 -i 5'"

[tasks."benchmark:ci-json"]
description = "Run benchmarks with CI configuration and JSON output (for workflow/testing)"
run = """
./mvnw -pl benchmarks -am -DskipTests clean package
JMH_ARGS="${JMH_ARGS:--f 3 -wi 3 -i 5}"
echo "Running benchmarks with args: $JMH_ARGS"
java -jar ./benchmarks/target/benchmarks.jar -rf json -rff benchmark-results.json $JMH_ARGS
"""

[tasks."benchmark:generate-summary"]
description = "Generate summary from existing benchmark-results.json"
run = "python3 ./.mise/tasks/generate_benchmark_summary.py"
